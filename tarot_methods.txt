/**
 * æ„å»ºå¡”ç½—ç‰Œè§£è¯»æç¤ºè¯
 */
private static buildTarotPrompt(
  cards: StoryTarotCard[],
  spread: TarotSpread,
  question: string
): string {
  const cardsInfo = cards.map((card, index) => {
    const position = spread.positions[index];
    return `ä½ç½®${index + 1}(${position.name}): ${card.name} - ${card.meaning}${card.reverseReading ? ` (é€†ä½å«ä¹‰: ${card.reverseReading})` : ''}`;
  }).join('\n');

  return `ä½ æ˜¯ä¸€åèµ„æ·±ä¸“ä¸šçš„å¡”ç½—ç‰Œå åœå¸ˆï¼Œæ‹¥æœ‰20å¹´ä»¥ä¸Šçš„ä¸°å¯Œç»éªŒã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ä¸ºç”¨æˆ·æä¾›æ·±åº¦çš„å¡”ç½—ç‰Œè§£è¯»ï¼š

**ç”¨æˆ·é—®é¢˜**: ${question || 'å¯»æ±‚äººç”ŸæŒ‡å¯¼'}

**ç‰Œé˜µä¿¡æ¯**: ${spread.name} - ${spread.description}

**æŠ½ä¸­çš„ç‰Œ**:
${cardsInfo}

è¯·æä¾›ä¸€ä¸ªç»“æ„åŒ–çš„è§£è¯»ï¼Œä»¥JSONæ ¼å¼è¿”å›ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

{
  "overallInterpretation": {
    "title": "æ•´ä½“è§£è¯»",
    "content": "ç»¼åˆåˆ†ææ‰€æœ‰å¡ç‰Œçš„æ•´ä½“å«ä¹‰ï¼Œç»™å‡ºæ·±åº¦æ´å¯Ÿ"
  },
  "cardInterpretations": [
    {
      "position": "ä½ç½®åç§°",
      "cardName": "å¡ç‰Œåç§°",
      "interpretation": "è¯¥ä½ç½®ä¸Šè¿™å¼ å¡ç‰Œçš„è¯¦ç»†è§£è¯»"
    }
  ],
  "guidance": {
    "title": "æŒ‡å¯¼å»ºè®®",
    "content": "åŸºäºè§£è¯»ç»“æœï¼Œç»™å‡ºå…·ä½“å¯è¡Œçš„ç”Ÿæ´»å»ºè®®"
  },
  "summary": {
    "title": "æ ¸å¿ƒè¦ç‚¹",
    "content": "æ€»ç»“æœ€é‡è¦çš„å¯ç¤ºå’Œè¦ç‚¹"
  }
}

è§£è¯»è¦æ±‚ï¼š
1. æ·±åº¦ä¸“ä¸šï¼Œä½“ç°å¡”ç½—å åœå¸ˆçš„ä¸“ä¸šæ°´å‡†
2. ç»“åˆç”¨æˆ·é—®é¢˜ï¼Œç»™å‡ºé’ˆå¯¹æ€§çš„è§£è¯»
3. è¯­è¨€æ¸©æš–æœ‰åŠ›é‡ï¼Œç»™äººå¸Œæœ›å’ŒæŒ‡å¯¼
4. æ¯å¼ å¡ç‰Œè§£è¯»è¦ç»“åˆå…¶åœ¨ç‰Œé˜µä¸­çš„ä½ç½®å«ä¹‰
5. æ•´ä½“è§£è¯»è¦æœ‰é€»è¾‘æ€§å’Œè¿è´¯æ€§`;
}

/**
 * è·å–æœ¬åœ°å¡”ç½—ç‰Œè§£è¯»ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
 */
private static getLocalTarotInterpretation(
  cards: StoryTarotCard[],
  spread: TarotSpread,
  question: string
): StructuredTarotInterpretation {
  console.log('ğŸ  ä½¿ç”¨æœ¬åœ°å¡”ç½—è§£è¯»');

  const cardInterpretations = cards.map((card, index) => {
    const position = spread.positions[index];
    const baseInterpretation = card.storyReading || card.meaning;
    
    return {
      position: position.name,
      cardName: card.name,
      interpretation: `åœ¨"${position.name}"ä½ç½®ä¸Šï¼Œ${card.name}æš—ç¤º${baseInterpretation}ã€‚è¿™å¼ ç‰Œçš„èƒ½é‡æé†’æ‚¨è¦${this.generateCardAdvice(card)}ã€‚`
    };
  });

  const overallThemes = cards.map(card => card.keywords || card.name).join('ã€');
  const overallInterpretation = {
    title: 'æ•´ä½“èƒ½é‡è§£è¯»',
    content: `é€šè¿‡${spread.name}ï¼Œæˆ‘ä»¬çœ‹åˆ°æ‚¨å½“å‰çš„èƒ½é‡åœºå›´ç»•ç€${overallThemes}ç­‰ä¸»é¢˜å±•å¼€ã€‚${this.generateOverallGuidance(cards, question)}`
  };

  const guidance = {
    title: 'æ™ºæ…§æŒ‡å¼•',
    content: this.generateTarotGuidance(cards, question)
  };

  const summary = {
    title: 'æ ¸å¿ƒå¯ç¤º',
    content: `${spread.name}ä¸ºæ‚¨æ­ç¤ºçš„æ ¸å¿ƒä¿¡æ¯æ˜¯ï¼š${this.generateCoreSummary(cards)}ã€‚ç›¸ä¿¡è‡ªå·±çš„ç›´è§‰ï¼ŒæŒ‰ç…§å†…å¿ƒçš„æŒ‡å¼•å‰è¡Œã€‚`
  };

  return {
    overallInterpretation,
    cardInterpretations,
    guidance,
    summary
  };
}

/**
 * å°†æ™®é€šæ–‡æœ¬è½¬æ¢ä¸ºç»“æ„åŒ–è§£è¯»æ ¼å¼
 */
private static convertToStructuredInterpretation(
  content: string,
  cards: StoryTarotCard[],
  spread: TarotSpread
): StructuredTarotInterpretation {
  const sections = content.split('\n\n');
  
  return {
    overallInterpretation: {
      title: 'æ•´ä½“è§£è¯»',
      content: sections[0] || content.substring(0, 300)
    },
    cardInterpretations: cards.map((card, index) => ({
      position: spread.positions[index]?.name || `ä½ç½®${index + 1}`,
      cardName: card.name,
      interpretation: sections[index + 1] || `${card.name}åœ¨æ­¤ä½ç½®å¸¦æ¥${card.meaning}çš„èƒ½é‡ã€‚`
    })),
    guidance: {
      title: 'æŒ‡å¯¼å»ºè®®',
      content: sections[sections.length - 2] || 'è¯·æŒ‰ç…§å†…å¿ƒçš„ç›´è§‰ï¼Œç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­ã€‚'
    },
    summary: {
      title: 'æ ¸å¿ƒå¯ç¤º',
      content: sections[sections.length - 1] || 'ä¿æŒå¼€æ”¾çš„å¿ƒæ€ï¼Œè¿æ¥ç”Ÿæ´»çš„è½¬å˜ã€‚'
    }
  };
}

/**
 * ç”Ÿæˆå•å¼ å¡ç‰Œå»ºè®®
 */
private static generateCardAdvice(card: StoryTarotCard): string {
  const adviceMap: {[key: string]: string} = {
    'æ„šè€…': 'ä¿æŒåˆå¿ƒï¼Œå‹‡æ•¢è¸å‡ºç¬¬ä¸€æ­¥',
    'é­”æœ¯å¸ˆ': 'å‘æŒ¥ä¸ªäººæ‰èƒ½ï¼Œä¸»åŠ¨åˆ›é€ æœºä¼š',
    'å¥³ç¥­å¸': 'å€¾å¬å†…å¿ƒçš„å£°éŸ³ï¼Œç›¸ä¿¡ç›´è§‰',
    'çš‡å': 'å±•ç°æ¯æ€§çš„å…³æ€€ï¼Œæ»‹å…»èº«è¾¹çš„äºº',
    'çš‡å¸': 'æ‰¿æ‹…è´£ä»»ï¼Œä»¥ç¨³é‡çš„æ€åº¦é¢å¯¹æŒ‘æˆ˜',
    'æ•™çš‡': 'å¯»æ±‚æ™ºæ…§çš„æŒ‡å¯¼ï¼Œéµå¾ªä¼ ç»Ÿä»·å€¼',
    'æ‹äºº': 'åšå‡ºé‡è¦çš„é€‰æ‹©ï¼Œè¯šå®é¢å¯¹å†…å¿ƒ',
    'æˆ˜è½¦': 'é›†ä¸­æ„å¿—åŠ›ï¼Œå‹‡æ•¢å‘å‰è¿›',
    'åŠ›é‡': 'ç”¨å†…åœ¨çš„åŠ›é‡å…‹æœå›°éš¾',
    'éšè€…': 'å†…çœåæ€ï¼Œå¯»æ‰¾å†…åœ¨çš„ç­”æ¡ˆ',
    'å‘½è¿ä¹‹è½®': 'æ¥å—å˜åŒ–ï¼Œé€‚åº”æ–°çš„ç¯å¢ƒ',
    'æ­£ä¹‰': 'å…¬æ­£å…¬å¹³ï¼Œæ‰¿æ‹…è¡Œä¸ºçš„åæœ',
    'å€’åŠäºº': 'æ¢ä¸ªè§’åº¦æ€è€ƒï¼Œå­¦ä¼šæ”¾ä¸‹',
    'æ­»ç¥': 'æ¥å—ç»“æŸï¼Œä¸ºæ–°çš„å¼€å§‹åšå‡†å¤‡',
    'èŠ‚åˆ¶': 'ä¿æŒå¹³è¡¡ï¼Œä»¥ä¸­åº¸ä¹‹é“è¡Œäº‹',
    'æ¶é­”': 'è®¤æ¸…è¯±æƒ‘ï¼Œè·å¾—å†…åœ¨çš„è‡ªç”±',
    'å¡”': 'çªç ´æ—§æœ‰çš„æ¡†æ¶ï¼Œé‡å»ºæ–°çš„åŸºç¡€',
    'æ˜Ÿæ˜Ÿ': 'ä¿æŒå¸Œæœ›ï¼Œç›¸ä¿¡ç¾å¥½çš„æœªæ¥',
    'æœˆäº®': 'é¢å¯¹å†…å¿ƒçš„ææƒ§ï¼Œæ¢ç´¢æ½œæ„è¯†',
    'å¤ªé˜³': 'ä¿æŒä¹è§‚ç§¯æï¼Œæ•£å‘æ­£èƒ½é‡',
    'å®¡åˆ¤': 'åæ€è¿‡å»ï¼Œä¸ºé‡ç”Ÿåšå‡†å¤‡',
    'ä¸–ç•Œ': 'å®Œæˆé‡è¦çš„é˜¶æ®µï¼Œåº†ç¥æˆå°±'
  };

  return adviceMap[card.name] || 'è·Ÿéšå¿ƒä¸­çš„æŒ‡å¼•ï¼ŒåšçœŸå®çš„è‡ªå·±';
}

/**
 * ç”Ÿæˆæ•´ä½“æŒ‡å¯¼
 */
private static generateOverallGuidance(cards: StoryTarotCard[], question: string): string {
  const themes = cards.map(card => card.keywords || 'æˆé•¿').join('ã€');
  const questionContext = question ? `é’ˆå¯¹æ‚¨å…³äº"${question}"çš„ç–‘é—®ï¼Œ` : '';
  
  return `${questionContext}å¡ç‰Œæ˜¾ç¤ºæ‚¨æ­£å¤„åœ¨ä¸€ä¸ªå…³äº${themes}çš„é‡è¦æ—¶æœŸã€‚è¿™ä¸ªé˜¶æ®µéœ€è¦æ‚¨ä¿æŒè€å¿ƒå’Œæ™ºæ…§ï¼Œç›¸ä¿¡ç”Ÿæ´»çš„å®‰æ’éƒ½æœ‰å…¶æ·±å±‚çš„æ„ä¹‰ã€‚`;
}

/**
 * ç”Ÿæˆå¡”ç½—æŒ‡å¯¼å»ºè®®
 */
private static generateTarotGuidance(cards: StoryTarotCard[], question: string): string {
  const cardCount = cards.length;
  const firstCard = cards[0];
  const lastCard = cards[cards.length - 1];
  
  let guidance = `é€šè¿‡è¿™${cardCount}å¼ ç‰Œï¼Œå¡”ç½—ä¸ºæ‚¨å¸¦æ¥ä»¥ä¸‹æŒ‡å¼•ï¼š\n\n`;
  
  guidance += `1. **å½“å‰çŠ¶æ€**: ${firstCard.name}æ˜¾ç¤ºæ‚¨ç°åœ¨${firstCard.meaning}ï¼Œè¿™æ˜¯æ‚¨çš„èµ·ç‚¹ã€‚\n`;
  
  if (cardCount > 1) {
    guidance += `2. **å‘å±•æ–¹å‘**: ${lastCard.name}æŒ‡å‘${lastCard.meaning}ï¼Œè¿™æ˜¯æ‚¨çš„ç›®æ ‡æ–¹å‘ã€‚\n`;
  }
  
  guidance += `\nå»ºè®®æ‚¨ï¼šä¿æŒå¼€æ”¾çš„å¿ƒæ€ï¼Œç›¸ä¿¡å†…åœ¨çš„æ™ºæ…§ï¼Œæ¯ä¸€ä¸ªæŒ‘æˆ˜éƒ½æ˜¯æˆé•¿çš„æœºä¼šã€‚`;
  
  return guidance;
}

/**
 * ç”Ÿæˆæ ¸å¿ƒæ€»ç»“
 */
private static generateCoreSummary(cards: StoryTarotCard[]): string {
  const mainThemes = cards.slice(0, 2).map(card => card.keywords || card.name).join('ä¸');
  return `${mainThemes}çš„èƒ½é‡å°†æŒ‡å¼•æ‚¨èµ°å‘æ›´é«˜çš„æ™ºæ…§å’Œæˆé•¿`;
} 